<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baskakov CMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* FONTS */
        @font-face {
            font-family: 'TT Neoris';
            src: url('https://res.cloudinary.com/dt79npeea/raw/upload/v1764859192/TT_Neoris_Regular_bb9kfp.woff2') format('woff2');
            font-weight: 400; font-style: normal;
        }
        @font-face {
            font-family: 'TT Neoris';
            src: url('https://res.cloudinary.com/dt79npeea/raw/upload/v1764859192/TT_Neoris_Regular_bb9kfp.woff2') format('woff2');
            font-weight: 500; font-style: normal;
        }

        body { font-family: 'TT Neoris', sans-serif; background-color: #000; color: white; -webkit-font-smoothing: antialiased; }
        .tracking-custom-tight { letter-spacing: -0.04em; }
        .hidden-force { display: none !important; }
        .fade-in { animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* UI ELEMENTS */
        input {
            background: #000; 
            border: 1px solid #1a1a1a; 
            color: white;
            /* Mobile Default */
            padding: 25px 20px; 
            font-size: 1.1rem;
            width: 100%; 
            border-radius: 0px; 
            outline: none; 
            transition: all 0.3s;
            font-family: 'TT Neoris', sans-serif;
            font-weight: 300;
        }
        textarea {
            background: #000; 
            border: 1px solid #1a1a1a; 
            color: white;
            /* Mobile Default */
            padding: 20px; 
            font-size: 1rem;
            width: 100%; 
            border-radius: 0px; 
            outline: none; 
            transition: all 0.3s;
            font-family: 'TT Neoris', sans-serif;
        }
        input:focus, textarea:focus { border-color: #333; background: #050505; }

        /* DESKTOP OVERRIDES (Large Inputs) */
        @media (min-width: 768px) {
            input {
                padding: 50px 30px; 
                font-size: 1.5rem; 
            }
            textarea {
                padding: 40px; 
                font-size: 1.2rem;
            }
        }
        
        label { 
            display: block; 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            letter-spacing: 0.1em; 
            color: rgba(255,255,255,0.3); 
            margin-bottom: 12px; 
        }
        @media (min-width: 768px) {
            label { font-size: 0.9rem; margin-bottom: 16px; }
        }

        /* CONVERTED PRICE DISPLAY */
        .converted-price {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.4);
            margin-top: 12px;
            display: block;
            font-variant-numeric: tabular-nums;
            font-weight: 400;
            padding-left: 20px; 
            letter-spacing: 0.02em;
        }
        @media (min-width: 768px) {
            .converted-price { padding-left: 30px; }
        }
        
        /* NAVIGATION */
        .tab-btn {
            padding: 24px 32px; 
            font-size: 0.9rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em;
            color: rgba(255,255,255,0.4); 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            transition: all 0.3s;
            text-align: left;
            background: black;
            width: 100%;
        }
        .tab-btn:hover { color: white; background: #0a0a0a; }
        .tab-btn.active { color: white; border-bottom: 1px solid white; background: #111; }
        
        /* BUTTONS */
        .btn-action {
            background: white; color: black; font-weight: 500; 
            padding: 16px 30px; border-radius: 0; 
            transition: all 0.3s; border: 1px solid white;
            text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.9rem;
            cursor: pointer;
            width: auto;
            min-width: 100%; /* Mobile full width */
            text-align: center;
        }
        @media (min-width: 768px) {
            .btn-action {
                padding: 20px 40px; 
                font-size: 1rem;
                min-width: 200px;
                width: auto;
            }
        }
        .btn-action:hover { background: black; color: white; }

        /* TOGGLE SWITCH */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10B981;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #222;
            transition: .4s;
            border: 1px solid #333;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: #fff;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
            background-color: #000;
        }

        /* WORKLOAD BUTTONS */
        .btn-option { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.1); 
            background: #050505;
            position: relative;
            cursor: pointer;
        }
        .btn-option:hover { background-color: #151515; }
        
        /* ACTIVE STATE */
        .btn-option.active { 
            background-color: transparent; 
            border: 1px solid white; 
            box-shadow: 0 0 20px rgba(255,255,255,0.1); 
            z-index: 10;
            transform: scale(1.02);
        }
        .btn-option.active .num { color: white !important; opacity: 1; }
        .btn-option.active .lbl { color: white !important; opacity: 1; }
        
        /* MODAL */
        .modal-overlay {
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
        }

        /* TOAST NOTIFICATION */
        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #111;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 200;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            width: 90%; /* Mobile safe width */
            max-width: fit-content;
            justify-content: center;
        }
        #toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* GRID LAYOUT */
        .admin-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: 100vh; 
            overflow: hidden; 
        }
        .sidebar { overflow-y: auto; }
        .scrollable-main { overflow-y: auto; height: 100%; position: relative; }

        @media(max-width: 1024px) {
            .admin-layout { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .sidebar { overflow-x: auto; flex-direction: row !important; border-right: none !important; border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; height: auto; }
            .tab-btn { flex: 1; text-align: center; white-space: nowrap; padding: 20px 15px; font-size: 0.8rem; }
        }
    </style>
</head>
<body class="bg-black h-full">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-black overflow-y-auto p-4">
        <div class="w-full max-w-lg p-8 md:p-16 border border-white/20 bg-[#050505] shadow-2xl relative my-auto">
            <div class="absolute top-0 left-0 w-full h-0.5 bg-white"></div>
            <h2 class="text-3xl md:text-4xl font-medium tracking-custom-tight uppercase mb-8 md:mb-10">CMS Access</h2>
            <form id="login-form" class="space-y-6 md:space-y-8">
                <div>
                    <label>Email</label>
                    <input type="email" id="email-input" placeholder="admin@example.com" required class="tracking-wide">
                </div>
                <div>
                    <label>Password</label>
                    <input type="password" id="password-input" placeholder="••••••" required class="tracking-wide">
                </div>
                <button type="submit" class="btn-action w-full mt-6">Login</button>
            </form>
            <p id="login-error" class="text-red-500 text-xs uppercase tracking-widest mt-6 hidden text-center animate-pulse">Incorrect Credentials</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-content" class="hidden-force opacity-0 w-full h-full admin-layout">
        
        <!-- Sidebar -->
        <nav class="sidebar flex flex-col border-r border-white/10 bg-black">
            <div class="p-6 md:p-10 border-b border-white/10 flex-shrink-0">
                <h1 class="text-xl md:text-2xl font-medium tracking-tight">Baskakov</h1>
                <span id="connection-status" class="text-[10px] uppercase tracking-widest text-emerald-500 mt-2 block flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Online
                </span>
            </div>
            <button class="tab-btn active" onclick="switchTab('workload')">Загруженность</button>
            <button class="tab-btn" onclick="switchTab('profile')">Профиль</button>
            <button class="tab-btn" onclick="switchTab('prices')">Цена</button>
            <button class="tab-btn" onclick="switchTab('reviews')">Отзывы</button>
            <div class="mt-auto p-8 hidden lg:block">
                <button onclick="window.logout()" class="text-xs text-white/30 hover:text-white uppercase tracking-widest transition">Выйти</button>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="scrollable-main bg-[#050505]">
            <div class="p-6 md:p-8 lg:p-20 w-full max-w-7xl mx-auto">
            
                <!-- TAB: WORKLOAD -->
                <div id="tab-workload" class="tab-content space-y-8 md:space-y-12 w-full pb-32">
                    <div class="border-b border-white/10 pb-6 md:pb-8 flex justify-between items-end">
                        <div>
                            <h2 class="text-3xl md:text-5xl font-medium mb-3 tracking-custom-tight">Загруженность</h2>
                            <p class="text-white/50 text-sm md:text-lg">Текущий статус на сайте: <span id="current-workload-text" class="text-white font-bold ml-1 md:ml-2">...</span></p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 md:gap-6">
                        <!-- JS generated buttons -->
                    </div>
                </div>

                <!-- TAB: PROFILE -->
                <div id="tab-profile" class="tab-content hidden space-y-8 md:space-y-12 w-full pb-32">
                    <div class="border-b border-white/10 pb-6 md:pb-8">
                        <h2 class="text-3xl md:text-5xl font-medium mb-3 tracking-custom-tight">Профиль</h2>
                    </div>
                    <div class="space-y-8 md:space-y-10 w-full max-w-3xl">
                        <div>
                            <label>Главный заголовок (Имя)</label>
                            <input type="text" id="prof-name">
                        </div>
                        <div>
                            <label>Подзаголовок (Роль)</label>
                            <input type="text" id="prof-role">
                        </div>
                        <button onclick="saveProfile()" class="btn-action">Сохранить</button>
                    </div>
                </div>

                <!-- TAB: PRICES -->
                <div id="tab-prices" class="tab-content hidden space-y-12 md:space-y-16 w-full pb-48">
                    <div class="border-b border-white/10 pb-6 md:pb-8 flex flex-col md:flex-row md:justify-between md:items-end gap-6">
                        <div>
                            <h2 class="text-3xl md:text-5xl font-medium mb-3 tracking-custom-tight">Цена</h2>
                            <p class="text-white/50 text-sm md:text-lg">Цены вводятся в рублях, конвертация автоматическая</p>
                        </div>
                        
                        <!-- ROUNDING TOGGLE -->
                        <div class="flex items-center gap-4">
                            <span class="text-xs md:text-sm uppercase tracking-widest text-white/60">Округлять цены</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="rounding-toggle" onchange="toggleRounding()">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Курс Валют -->
                    <div>
                        <div class="flex justify-between items-end mb-4 md:mb-6">
                            <label class="text-white text-xs md:text-sm mb-0">Текущий курс</label>
                            <button onclick="openRateModal()" class="text-[10px] md:text-xs uppercase tracking-widest border-b border-white/30 pb-1 hover:text-white hover:border-white transition">Редактировать курс</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
                            <!-- USD Card -->
                            <div class="p-6 md:p-10 border border-white/10 bg-[#0a0a0a] flex flex-col justify-center items-center aspect-[2/1] md:aspect-video relative group">
                                <div class="text-white/30 text-[10px] md:text-xs uppercase tracking-widest absolute top-4 left-4 md:top-6 md:left-6">USD / RUB</div>
                                <div class="text-3xl md:text-5xl font-light tracking-tight text-center">
                                    1 USD = <span id="display-rate-usd">...</span> ₽
                                </div>
                            </div>
                            <!-- KZT Card -->
                            <div class="p-6 md:p-10 border border-white/10 bg-[#0a0a0a] flex flex-col justify-center items-center aspect-[2/1] md:aspect-video relative group">
                                <div class="text-white/30 text-[10px] md:text-xs uppercase tracking-widest absolute top-4 left-4 md:top-6 md:left-6">RUB / KZT</div>
                                <div class="text-3xl md:text-5xl font-light tracking-tight text-center">
                                    1 Рубль = <span id="display-rate-kzt">...</span> ₸
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Цены (Inputs) -->
                    <div class="space-y-12">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
                            <div class="space-y-8 md:space-y-10">
                                <h3 class="text-lg md:text-xl font-medium text-white border-b border-white/10 pb-4">Дизайн (Figma)</h3>
                                <div>
                                    <label>Лендинг (RUB)</label>
                                    <input type="number" id="price-design-landing" class="rub-input">
                                    <span id="calc-design-landing" class="converted-price">≈ $0 / 0 ₸</span>
                                </div>
                                <div>
                                    <label>Многостраничный (RUB)</label>
                                    <input type="number" id="price-design-multi" class="rub-input">
                                    <span id="calc-design-multi" class="converted-price">≈ $0 / 0 ₸</span>
                                </div>
                            </div>
                            <div class="space-y-8 md:space-y-10">
                                <h3 class="text-lg md:text-xl font-medium text-white border-b border-white/10 pb-4">Под ключ (Tilda)</h3>
                                <div>
                                    <label>Лендинг (RUB)</label>
                                    <input type="number" id="price-turnkey-landing" class="rub-input">
                                    <span id="calc-turnkey-landing" class="converted-price">≈ $0 / 0 ₸</span>
                                </div>
                                <div>
                                    <label>Многостраничный (RUB)</label>
                                    <input type="number" id="price-turnkey-multi" class="rub-input">
                                    <span id="calc-turnkey-multi" class="converted-price">≈ $0 / 0 ₸</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pt-8 border-t border-white/10">
                            <h3 class="text-lg md:text-xl font-medium text-white mb-6">Прочее</h3>
                            <div class="max-w-md">
                                <label>Стартовая цена (RUB)</label>
                                <input type="number" id="price-other" class="rub-input">
                                <span id="calc-other" class="converted-price">≈ $0 / 0 ₸</span>
                            </div>
                        </div>
                    </div>

                    <div class="fixed bottom-6 right-6 md:bottom-10 md:right-10 z-20 w-[calc(100%-3rem)] md:w-auto">
                         <button onclick="savePrices()" class="btn-action shadow-2xl w-full md:w-auto">Сохранить изменения</button>
                    </div>
                </div>

                <!-- TAB: REVIEWS -->
                <div id="tab-reviews" class="tab-content hidden space-y-8 md:space-y-12 w-full pb-32">
                    <div class="border-b border-white/10 pb-6 md:pb-8 flex justify-between items-end">
                        <h2 class="text-3xl md:text-5xl font-medium mb-3 tracking-custom-tight">Отзывы</h2>
                        <button onclick="seedReviews()" class="text-[10px] md:text-xs uppercase tracking-widest text-white/40 hover:text-white transition">Загрузить с сайта</button>
                    </div>

                    <div class="p-6 md:p-10 border border-white/10 bg-[#0a0a0a] space-y-6 md:space-y-8 max-w-4xl">
                        <h3 class="text-lg md:text-xl font-medium text-white uppercase tracking-widest border-b border-white/10 pb-4">Новый отзыв</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
                            <div class="md:col-span-2"><label>Автор</label><input type="text" id="rev-author" placeholder="@username"></div>
                            <div><label>Оценка</label><input type="number" id="rev-stars" value="5" min="1" max="5"></div>
                        </div>
                        <div>
                            <label>Текст отзыва</label>
                            <textarea id="rev-text" style="min-height: 400px; height: 60vh;" placeholder="Текст отзыва..."></textarea>
                        </div>
                        <button onclick="addReview()" class="btn-action">Добавить</button>
                    </div>

                    <div id="reviews-list" class="space-y-4 pb-20 grid gap-4 max-w-4xl">
                        <!-- JS List -->
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL: EDIT RATES -->
    <div id="rate-modal" class="fixed inset-0 z-[100] hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-[#111] border border-white/20 p-8 md:p-12 w-full max-w-md relative shadow-2xl">
            <button onclick="closeRateModal()" class="absolute top-4 right-4 md:top-6 md:right-6 text-white/50 hover:text-white">✕</button>
            <h3 class="text-xl md:text-2xl font-medium mb-8 md:mb-10 tracking-custom-tight">Редактирование курса</h3>
            <div class="space-y-6 md:space-y-8">
                <div>
                    <label>USD (Рублей за 1$)</label>
                    <input type="number" id="modal-rate-usd" step="0.01" class="text-xl md:text-2xl font-light">
                </div>
                <div>
                    <label>KZT (Тенге за 1₽)</label>
                    <input type="number" id="modal-rate-kzt" step="0.01" class="text-xl md:text-2xl font-light">
                </div>
                <button onclick="saveRatesFromModal()" class="btn-action w-full mt-4">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="rounded-full">
        <div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div>
        <span class="text-xs md:text-sm font-medium tracking-wide text-white uppercase">Успешно сохранено</span>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ТВОЙ КОНФИГ
        const firebaseConfig = {
            apiKey: "AIzaSyCzLSd-Jmlb2N-UIXYMqlLWfnkPZxBQFeU",
            authDomain: "portfolio-1a9ea.firebaseapp.com",
            projectId: "portfolio-1a9ea",
            storageBucket: "portfolio-1a9ea.firebasestorage.app",
            messagingSenderId: "314962967742",
            appId: "1:314962967742:web:9cb039f7376d9f853372ef",
            measurementId: "G-2QVRQB4GWY"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'portfolio-app';

        // GLOBAL STATE
        let isRounding = false;
        let currentRates = { USD: 96.5, KZT: 5.15 };

        // TOAST SYSTEM
        window.showToast = () => {
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // UI NAVIGATION
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if(tabName === 'prices') initPrices();
        };

        // AUTH
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-content').classList.remove('hidden-force');
                document.getElementById('main-content').classList.add('fade-in');
                initData();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-content').classList.add('hidden-force');
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email-input').value;
            const pass = document.getElementById('password-input').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        window.logout = () => signOut(auth);

        // DATA INIT
        function initData() {
            initWorkload();
            initProfile();
            initPrices();
            initReviews();
            // SETUP LIVE INPUT LISTENERS ONCE
            document.querySelectorAll('.rub-input').forEach(input => {
                input.addEventListener('input', updateCalculatedPrices);
            });
        }

        // 1. WORKLOAD
        function initWorkload() {
            const container = document.querySelector('#tab-workload .grid');
            container.innerHTML = '';
            const labels = ['Free', 'Light', 'Normal', 'Busy', 'High Demand', 'Sold Out'];
            
            labels.forEach((label, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn-option p-8 md:p-12 bg-black flex flex-col items-center gap-2 md:gap-4 relative group';
                btn.id = `wl-btn-${i}`;
                btn.onclick = () => setWorkload(i);
                btn.innerHTML = `
                    <span class="num text-4xl md:text-6xl font-light text-white/30 group-hover:text-white transition-colors tracking-tighter">${i}</span>
                    <span class="lbl text-[10px] md:text-xs uppercase tracking-[0.2em] text-white/50 group-hover:text-white transition-colors">${label}</span>
                `;
                container.appendChild(btn);
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'workload'), (snap) => {
                if (snap.exists()) {
                    const val = snap.data().level;
                    document.querySelectorAll('[id^="wl-btn-"]').forEach(b => b.classList.remove('active'));
                    const active = document.getElementById(`wl-btn-${val}`);
                    if(active) active.classList.add('active');
                    
                    document.getElementById('current-workload-text').textContent = labels[val] + ` (${val})`;
                }
            });
        }
        
        window.setWorkload = async (level) => {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'workload'), { level });
        };

        // 2. PROFILE
        function initProfile() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'profile'), (snap) => {
                if (snap.exists()) {
                    const d = snap.data();
                    document.getElementById('prof-name').value = d.name || '';
                    document.getElementById('prof-role').value = d.role || '';
                }
            });
        }
        window.saveProfile = async () => {
            const name = document.getElementById('prof-name').value;
            const role = document.getElementById('prof-role').value;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'profile'), { name, role });
            showToast();
        };

        // 3. PRICES & RATES

        window.initPrices = function() {
             getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'prices')).then((snap) => {
                if (snap.exists()) updatePricesUI(snap.data());
            });
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'prices'), (snap) => {
                if (snap.exists()) updatePricesUI(snap.data());
            });
        }

        function updatePricesUI(data) {
            // Prices inputs
            const inputs = ['price-design-landing', 'price-design-multi', 'price-turnkey-landing', 'price-turnkey-multi', 'price-other'];
            inputs.forEach(id => {
                document.getElementById(id).value = data[id.replace('price-', '').replace('-', '_')] || 0;
            });

            // Toggle state
            if(data.rounding !== undefined) {
                isRounding = data.rounding;
                document.getElementById('rounding-toggle').checked = isRounding;
            }

            // Rates
            if (data.rates) {
                currentRates = data.rates;
                document.getElementById('display-rate-usd').textContent = currentRates.USD;
                document.getElementById('display-rate-kzt').textContent = currentRates.KZT;
                document.getElementById('modal-rate-usd').value = currentRates.USD;
                document.getElementById('modal-rate-kzt').value = currentRates.KZT;
            }
            
            // Force recalculate display strings
            updateCalculatedPrices();
        }

        window.toggleRounding = () => {
            isRounding = document.getElementById('rounding-toggle').checked;
            updateCalculatedPrices();
        }

        function updateCalculatedPrices() {
            const inputs = ['price-design-landing', 'price-design-multi', 'price-turnkey-landing', 'price-turnkey-multi', 'price-other'];
            inputs.forEach(id => {
                const rubVal = parseFloat(document.getElementById(id).value) || 0;
                let usdVal = rubVal / currentRates.USD;
                let kztVal = rubVal * currentRates.KZT;

                if (isRounding) {
                    usdVal = Math.ceil(usdVal);
                    kztVal = Math.ceil(kztVal);
                } else {
                    usdVal = usdVal.toFixed(0);
                    kztVal = kztVal.toFixed(0);
                }
                
                // Format numbers (space as thousands separator)
                const fKzt = kztVal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                const fUsd = usdVal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                
                const displayId = id.replace('price-', 'calc-');
                document.getElementById(displayId).innerHTML = `≈ $${fUsd} <span class="mx-2 opacity-30">|</span> ${fKzt} ₸`;
            });
        }

        // Modal Logic
        window.openRateModal = () => document.getElementById('rate-modal').classList.remove('hidden');
        window.closeRateModal = () => document.getElementById('rate-modal').classList.add('hidden');
        
        window.saveRatesFromModal = async () => {
            const newRates = {
                USD: Number(document.getElementById('modal-rate-usd').value),
                KZT: Number(document.getElementById('modal-rate-kzt').value)
            };
            await savePrices(newRates, false); 
            closeRateModal();
        };

        window.savePrices = async (rateOverride = null, showNotif = true) => {
            const prices = {
                design_landing: Number(document.getElementById('price-design-landing').value),
                design_multi: Number(document.getElementById('price-design-multi').value),
                turnkey_landing: Number(document.getElementById('price-turnkey-landing').value),
                turnkey_multi: Number(document.getElementById('price-turnkey-multi').value),
                other: Number(document.getElementById('price-other').value),
                rounding: isRounding,
                rates: rateOverride || {
                    USD: Number(document.getElementById('modal-rate-usd').value) || currentRates.USD,
                    KZT: Number(document.getElementById('modal-rate-kzt').value) || currentRates.KZT
                }
            };
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'prices'), prices);
            if(showNotif) showToast();
        };

        // 4. REVIEWS
        function initReviews() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'reviews'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('reviews-list');
                list.innerHTML = '';
                snap.forEach(docSnap => {
                    const r = docSnap.data();
                    const el = document.createElement('div');
                    el.className = 'p-6 border border-white/10 bg-[#0a0a0a] flex flex-col md:flex-row justify-between items-start gap-4';
                    el.innerHTML = `
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <span class="font-bold text-white text-base md:text-lg">${r.author}</span>
                                <span class="text-white/50 text-xs md:text-sm">★ ${r.stars}</span>
                            </div>
                            <p class="text-white/70 text-sm md:text-base leading-relaxed">${r.text}</p>
                        </div>
                        <button onclick="delReview('${docSnap.id}')" class="text-red-500 hover:text-white px-4 py-2 border border-red-500/20 hover:bg-red-500/10 transition uppercase tracking-widest text-[10px] md:text-xs shrink-0 self-end md:self-start">Удалить</button>
                    `;
                    list.appendChild(el);
                });
            });
        }

        window.addReview = async () => {
            const author = document.getElementById('rev-author').value;
            const stars = Number(document.getElementById('rev-stars').value);
            const text = document.getElementById('rev-text').value;
            if(!author || !text) return alert("Заполните поля");

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reviews'), {
                author, stars, text, timestamp: Date.now()
            });
            
            document.getElementById('rev-author').value = '';
            document.getElementById('rev-text').value = '';
            showToast();
        };

        window.delReview = async (id) => {
            if(confirm("Удалить?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reviews', id));
            }
        };

        window.seedReviews = async () => {
            if(!confirm("Добавить стандартные отзывы?")) return;
            const batch = writeBatch(db);
            const defaults = [
                { author: "zkurbanov85", stars: 5, text: "Никита, благодарю Вас! ! Ваша терпеливая и вдумчивая работа позволила мне наконец заиметь свой таплинк. Буду обращаться вновь! !" },
                { author: "aikaagness", stars: 5, text: "Большое спасибо Никите за отличную работу! замечательный сайт, всё было сделано очень профессионально и в сроки. Я очень довольна результатом." },
                { author: "TyapkinaProProdazhi", stars: 5, text: "Очень довольна работой! Выполнено было все быстро, все по ТЗ. Использовал интересные подходы, всё предложенное было красиво, хорошо оформленно." },
                { author: "Yuristyuga", stars: 5, text: "Огромная благодарность. Учтены все пожелания. Представил три варианта таплинка. Отвечает быстро. Работа выполнена в срок. Буду обращаться еще." }
            ];
            defaults.forEach(d => {
                const ref = doc(collection(db, 'artifacts', appId, 'public', 'data', 'reviews'));
                batch.set(ref, { ...d, timestamp: Date.now() });
            });
            await batch.commit();
        };

    </script>
</body>
</html>
